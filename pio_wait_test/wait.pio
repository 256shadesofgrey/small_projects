.program pulse_generator
.wrap_target
    pull block          ; Получить значение ширины импульса
    mov x, osr          ; Загрузить значение в x
    set pins, 1         ; Установить пин в высокое состояние
loop:
    jmp x--, loop       ; Ждать указанное количество циклов
    set pins, 0         ; Установить пин в низкое состояние
.wrap                   ; Вернуться к началу для следующего запуска

.program pulse_detector
.wrap_target
    wait 0 pin 0        ; ожидаем низкий уровень сигнала
    wait 1 pin 0        ; ожидаем положительный фронт (начало импульса)
    mov y ~NULL         ; инициализируем счетчик максимальным значением
count_loop:
    jmp pin continue    ; проверяем, все еще ли высокий уровень на пине
    jmp finish          ; если нет, импульс закончился - переходим к сохранению результата
continue:
    jmp y-- count_loop  ; декрементируем счетчик и продолжаем
    ; если y достиг нуля, значит импульс слишком длинный
finish:
    mov ISR ~y          ; получаем длительность импульса (0xFFFFFFFF - y)
    push                ; помещаем значение в FIFO
.wrap                   ; возврат для измерения следующего импульса
